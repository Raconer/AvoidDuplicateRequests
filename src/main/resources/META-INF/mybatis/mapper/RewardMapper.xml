<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duplicate.requests.avoid.api.reward.mapper.RewardMapper">

    <!-- Create -->
    <insert id="insert" parameterType="RewardInfoDto">
        <![CDATA[  
            INSERT INTO `reward` (`user_idx`, `reg_date`, `count`) 
            SELECT  #{userIdx}, 
                    #{regDate}, 
                    (CASE
                        WHEN `r`.`count` IS NULL
                            THEN 1
                        ELSE IF( `r`.`count` >= 10, 1, `r`.`count`+ 1 ) 
                    END ) as `count`
            FROM `user` `u`
            LEFT JOIN `reward` `r`
                ON `u`.`idx` = `r`.`user_idx`
                AND `r`.`reg_date` >= #{yesterDate}
            WHERE  `u`.`idx` =  #{userIdx}
            AND (
                SELECT COUNT(`r1`.`idx`) 
                FROM `reward` `r1` 
                WHERE `r1`.`reg_date` >=  DATE_ADD(#{yesterDate}, INTERVAL 1 DAY)
                AND  `r1`.`user_idx` =  #{userIdx}
                ) = 0 
            LIMIT  1;
        ]]>
    </insert>

</mapper>